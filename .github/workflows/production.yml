name: Production Build Action
run-name: ${{github.actor}} is building for production
on: 
  push:
    branches:
      - production
permissions:
  id-token: write
  contents: read
env:
  AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLOUDFLARE_DEFAULT_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_DEFAULT_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
jobs:
  SST-Deploy-Production:
    if: ${{ github.ref == 'refs/heads/production' }}
    runs-on: ubuntu-latest
    steps:
      # meta data
      - run: echo "Deploying to production on branch $GITHUB_REF"
      - run: echo "Build triggered by ${{ github.event_name }}"
      - run: echo "Building on ${{ runner.os }}"
      # fetch repo
      - name: Check out code
        uses: actions/checkout@v2
      - run: echo "Checked out ${{ github.repository }}"
      # aws
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      # install Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: echo "Installed bun"
      # ROTFB
      - run: bun install
      - run: bun sst deploy --stage=production --verbose


